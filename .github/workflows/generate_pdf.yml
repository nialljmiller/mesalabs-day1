name: Generate Documentation PDFs
on:
  push:
    paths:
      - 'lab1/README.md'
      - 'lab1/batch_runs/README.md'

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    name: Generate Documentation PDFs
    permissions:
      contents: write  # Crucial permission for repository operations
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install pandoc and LaTeX dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra
          
      - name: Create output directories
        run: |
          mkdir -p lab1/pdf
          mkdir -p lab1/batch_runs/pdf
          
      - name: Generate main README PDF
        run: |
          pandoc lab1/README.md \
            --from markdown \
            --template=https://raw.githubusercontent.com/openjournals/joss/master/assets/latex.template \
            --pdf-engine=xelatex \
            -o lab1/pdf/README.pdf
        
      - name: Generate batch runs README PDF
        if: hashFiles('lab1/batch_runs/README.md') != ''
        run: |
          pandoc lab1/batch_runs/README.md \
            --from markdown \
            --template=https://raw.githubusercontent.com/openjournals/joss/master/assets/latex.template \
            --pdf-engine=xelatex \
            -o lab1/batch_runs/pdf/README.pdf
            
      - name: Commit PDFs to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add the PDFs to git
          git add lab1/pdf/README.pdf || echo "Main PDF not found"
          git add lab1/batch_runs/pdf/README.pdf || echo "Batch runs PDF not found"
          
          # Only commit if there are changes to commit
          git diff --staged --quiet || git commit -m "Update documentation PDFs [skip ci]"
          
      - name: Push changes
        # The '[skip ci]' in the commit message prevents an infinite loop of workflow runs
        run: git push